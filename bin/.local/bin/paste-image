#!/bin/bash
# paste-image - Fetch clipboard image from Mac via reverse SSH tunnel
#
# Uses the reverse SSH tunnel (RemoteForward 9011 localhost:22) to connect
# back to the local Mac and fetch the clipboard image.
# Uses ProxyCommand to jump through dockerhost to reach the tunnel.
#
# Usage: paste-image
# Output: Path to the saved image file (for pasting into Claude Code)

set -e

# Configuration
LOCAL_USER="${LOCAL_USER:-rwarne}"
SSH_PORT=9011
TEMP_DIR="/tmp/clipboard-images"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
IMAGE_PATH="${TEMP_DIR}/clipboard_${TIMESTAMP}.png"

# Ensure temp directory exists
mkdir -p "$TEMP_DIR"

# SSH back to Mac through the reverse tunnel and fetch clipboard image
# Detect if we're in a container (dockerhost exists) or on the host directly
if ssh -o BatchMode=yes -o ConnectTimeout=1 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null dockerhost true 2>/dev/null; then
    # Inside container: use ProxyCommand to jump through dockerhost
    ssh -o StrictHostKeyChecking=no \
        -o UserKnownHostsFile=/dev/null \
        -o LogLevel=ERROR \
        -o ConnectTimeout=10 \
        -o "ProxyCommand=ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -W %h:%p dockerhost" \
        -p "$SSH_PORT" \
        "${LOCAL_USER}@localhost" \
        "~/.local/bin/clipboard-image-serve" > "$IMAGE_PATH" 2>/dev/null
else
    # On host directly: connect straight to localhost
    ssh -o StrictHostKeyChecking=no \
        -o UserKnownHostsFile=/dev/null \
        -o LogLevel=ERROR \
        -o ConnectTimeout=10 \
        -p "$SSH_PORT" \
        "${LOCAL_USER}@localhost" \
        "~/.local/bin/clipboard-image-serve" > "$IMAGE_PATH" 2>/dev/null
fi

# Check if we got valid image data
if [ ! -s "$IMAGE_PATH" ]; then
    rm -f "$IMAGE_PATH"
    echo "Error: No image in clipboard or connection failed" >&2
    exit 1
fi

# Verify it's actually a PNG
if ! file "$IMAGE_PATH" | grep -q "PNG image"; then
    rm -f "$IMAGE_PATH"
    echo "Error: Clipboard does not contain a valid image" >&2
    exit 1
fi

# Output the path (this gets pasted into Claude Code)
echo "$IMAGE_PATH"
