FROM rocker/r-ver:4.5.2

# System dependencies for R packages and dev tools
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Build tools
    build-essential \
    gfortran \
    # Terminal/editor (neovim installed later via bob for latest version)
    tmux \
    zsh \
    # Utils
    curl \
    git \
    fd-find \
    ripgrep \
    unzip \
    direnv \
    # Kitty terminal tools (for kitten icat image display in MOTD banner)
    kitty \
    # Image conversion for snacks.nvim image preview in neovim
    imagemagick \
    # PDF rendering for snacks.nvim image viewer
    ghostscript \
    # LaTeX rendering for snacks.nvim (provides pdflatex)
    texlive-latex-base \
    # System resource monitor
    btop \
    # SSH server for proper terminal capabilities (kitty graphics protocol)
    openssh-server \
    # sudo for user permissions (not in r-ver base)
    sudo \
    # Python for radian and reticulate
    python3 \
    python3-pip \
    python3-venv \
    libpython3-dev \
    # R package system dependencies (for tidyverse, devtools, etc.)
    cmake \
    libglpk-dev \
    libnlopt-dev \
    libxml2-dev \
    libcurl4-openssl-dev \
    libssl-dev \
    libfontconfig1-dev \
    libfreetype6-dev \
    libpng-dev \
    libtiff5-dev \
    libjpeg-dev \
    libharfbuzz-dev \
    libfribidi-dev \
    # Lua + luarocks for nvim plugins that need native Lua packages
    lua5.4 \
    liblua5.4-dev \
    luarocks \
    # V8 engine and Chromium for R packages (V8, chromote)
    # Must be installed before nodesource nodejs to avoid dependency conflicts
    libv8-dev \
    chromium \
    # Cleanup
    && rm -rf /var/lib/apt/lists/*

# Install Node.js (pre-built binary, avoids nvm compiling from source)
RUN curl -fsSL https://deb.nodesource.com/setup_22.x | bash - && \
    apt-get install -y nodejs && \
    rm -rf /var/lib/apt/lists/*


# Install rclone for cloud storage sync (Dropbox, etc.)
RUN curl -fsSL https://rclone.org/install.sh | bash

# Install deno (needed for peek.nvim markdown preview) - install to /usr/local/bin for all users
RUN curl -fsSL https://deno.land/install.sh | DENO_INSTALL=/usr/local sh

# Install neovim (latest stable via GitHub release)
RUN NVIM_VERSION=$(curl -s https://api.github.com/repos/neovim/neovim/releases/latest | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/') && \
    curl -LO "https://github.com/neovim/neovim/releases/download/${NVIM_VERSION}/nvim-linux-x86_64.tar.gz" && \
    tar -xzf nvim-linux-x86_64.tar.gz && \
    mv nvim-linux-x86_64 /opt/nvim && \
    ln -sf /opt/nvim/bin/nvim /usr/local/bin/nvim && \
    rm nvim-linux-x86_64.tar.gz

# Install fzf (latest from GitHub release - apt version is outdated)
RUN FZF_VERSION=$(curl -sI https://github.com/junegunn/fzf/releases/latest | grep -i "^location:" | sed -E 's|.*/v?([0-9.]+).*|\1|') && \
    curl -fsSL "https://github.com/junegunn/fzf/releases/download/v${FZF_VERSION}/fzf-${FZF_VERSION}-linux_amd64.tar.gz" | tar -xz -C /usr/local/bin

# Install fastfetch (latest from GitHub release)
RUN curl -LO https://github.com/fastfetch-cli/fastfetch/releases/latest/download/fastfetch-linux-amd64.deb && \
    dpkg -i fastfetch-linux-amd64.deb && \
    rm fastfetch-linux-amd64.deb

# Install AWS CLI v2
RUN curl -fsSL "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o /tmp/awscliv2.zip && \
    unzip -q /tmp/awscliv2.zip -d /tmp && \
    /tmp/aws/install && \
    rm -rf /tmp/awscliv2.zip /tmp/aws

# Install GitHub CLI (gh)
RUN curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
        | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
        | tee /etc/apt/sources.list.d/github-cli.list > /dev/null && \
    apt-get update && \
    apt-get install -y gh && \
    rm -rf /var/lib/apt/lists/*

# Install carapace (multi-shell completion engine with rich descriptions)
# Version extracted from redirect header to avoid GitHub API rate limits
RUN CARAPACE_VERSION=$(curl -sI https://github.com/carapace-sh/carapace-bin/releases/latest | grep -i "^location:" | sed -E 's|.*/v([0-9.]+).*|\1|') && \
    curl -Lo /tmp/carapace.tar.gz "https://github.com/carapace-sh/carapace-bin/releases/download/v${CARAPACE_VERSION}/carapace-bin_${CARAPACE_VERSION}_linux_amd64.tar.gz" && \
    tar xf /tmp/carapace.tar.gz -C /usr/local/bin carapace && \
    rm /tmp/carapace.tar.gz

# Install pak first (for fast binary package installs)
RUN R -e "install.packages('pak', repos = sprintf('https://r-lib.github.io/p/pak/stable/%s/%s/%s', .Platform\$pkgType, R.Version()\$os, R.Version()\$arch))"

# Install R packages for LSP and development
# Note: radian is installed per-project via direnv/uv to share Python with reticulate
# Data science packages (tidyverse, etc.) are installed per-project via renv
RUN R -e "pak::pak(c('languageserver', 'lintr', 'styler', 'devtools', 'here', 'renv'))" && \
    R -e "install.packages('cmdstanr', repos = c('https://stan-dev.r-universe.dev', getOption('repos')))"

# Copy entrypoint script (as root, before user switch)
COPY --chmod=755 docker/entrypoint.sh /usr/local/bin/entrypoint.sh

# Configure SSH server (runs on port 9015 to avoid conflict with host sshd)
# Must be done as root before user switch
# AcceptEnv allows client to pass terminal env vars for graphics protocol support
RUN mkdir -p /run/sshd && \
    echo "Port 9015" >> /etc/ssh/sshd_config && \
    echo "AcceptEnv TERM COLORTERM" >> /etc/ssh/sshd_config

# Create non-root user matching host UID (configurable at build time)
# TODO: DEV_PASSWORD is exposed in build layers/history. Use BuildKit secrets instead:
#       RUN --mount=type=secret,id=dev_password \
#           echo "${USERNAME}:$(cat /run/secrets/dev_password)" | chpasswd
#       Build with: docker build --secret id=dev_password,src=.env ...
ARG USER_ID=1000
ARG GROUP_ID=1000
ARG USERNAME=dev
ARG DEV_PASSWORD
RUN test -n "${DEV_PASSWORD}" || (echo "DEV_PASSWORD build arg is required" && exit 1)
RUN if getent passwd ${USER_ID} > /dev/null; then \
        existing_user=$(getent passwd ${USER_ID} | cut -d: -f1); \
        usermod -l ${USERNAME} -d /home/${USERNAME} -m -s /bin/zsh ${existing_user}; \
        groupmod -n ${USERNAME} $(getent group ${GROUP_ID} | cut -d: -f1); \
    else \
        groupadd -g ${GROUP_ID} ${USERNAME} && \
        useradd -m -u ${USER_ID} -g ${GROUP_ID} -s /bin/zsh ${USERNAME}; \
    fi && \
    echo "${USERNAME}:${DEV_PASSWORD}" | chpasswd && \
    usermod -aG sudo ${USERNAME} && \
    echo "${USERNAME} ALL=(ALL) NOPASSWD: /usr/sbin/sshd" >> /etc/sudoers.d/${USERNAME}

USER ${USERNAME}
WORKDIR /home/${USERNAME}

# Install uv for the user (used to manage per-project Python/radian)
RUN curl -LsSf https://astral.sh/uv/install.sh | sh

# Install CmdStan binaries for Bayesian modeling (brms/cmdstanr)
# cmdstanr R package is installed system-wide as root; CmdStan binaries go in user's ~/.cmdstan/
RUN R -e "cmdstanr::install_cmdstan()"

# Install tree-sitter CLI and mermaid-cli (user-local)
# tree-sitter-cli: needed for nvim-treesitter to compile parsers (e.g., custom grammars)
# mermaid-cli: needed for snacks.nvim to render Mermaid diagrams
RUN npm config set prefix ~/.local && npm install -g tree-sitter-cli @mermaid-js/mermaid-cli

# Install Claude Code CLI (native installer with auto-updates)
RUN curl -fsSL https://claude.ai/install.sh | bash

# Create .zshrc that sources dotfiles config
# First-boot setup (dotfiles install + Lazy sync) is handled by entrypoint.sh
RUN echo '# Source dotfiles zsh config\n\
[[ -f "$HOME/dotfiles/zsh/.zshrc" ]] && source "$HOME/dotfiles/zsh/.zshrc"' > ~/.zshrc

# Expose SSH port
EXPOSE 9015

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
CMD ["zsh"]
