services:
  r-dev:
    build:
      context: ..
      dockerfile: docker/Dockerfile.r-dev
      args:
        USER_ID: ${UID:-1000}
        GROUP_ID: ${GID:-1000}
        USERNAME: ${USER:-dev}
        GITHUB_PAT: ${GITHUB_PAT}
        DEV_PASSWORD: ${DEV_PASSWORD}
    image: r-dev:local
    container_name: rwt-mind-palace
    hostname: rwt-mind-palace
    stdin_open: true
    tty: true
    restart: unless-stopped
    ports:
      - "9012:35211" # httpgd
      - "9013:9013" # quarto preview
      - "9015:9015" # SSH
    volumes:
      # Mount dotfiles (install.sh creates symlinks to these)
      - ~/dotfiles:/home/${USER:-dev}/dotfiles
      # Mount projects directory (path matches host for venv compatibility)
      - ~/projects:/data/home/${USER:-dev}/projects
      # R package library (R default structure: ~/R/{platform}-library/{version})
      - ~/R:/home/${USER:-dev}/R
      # Mount ArgoAPI
      - /data/home/scott/projects/argoAPI:/home/${USER:-dev}/argoAPI:ro
      # Git/SSH config (read-only)
      - ~/.ssh:/home/${USER:-dev}/.ssh:ro
      - ~/.gitconfig:/home/${USER:-dev}/.gitconfig:ro
      # AWS credentials
      - ~/.aws:/home/${USER:-dev}/.aws:ro
      # Terminfo for ghostty terminal
      - ~/.terminfo:/home/${USER:-dev}/.terminfo:ro
      # rclone config for Dropbox sync
      - ~/.config/rclone:/home/${USER:-dev}/.config/rclone:ro
      # GitHub CLI auth
      - ~/.config/gh:/home/${USER:-dev}/.config/gh:ro
      # Claude Code auth and config
      - ~/.claude.json:/home/${USER:-dev}/.claude.json
      - ~/.claude:/home/${USER:-dev}/.claude
      - ~/.git-credentials:/home/${USER:-dev}/.git-credentials
      # Google auth tokens for gargle/googlesheets4/googledrive
      - ~/.secrets:/home/${USER:-dev}/.secrets
      # Environment variables (secrets, API keys, etc.)
      - ~/.env:/home/${USER:-dev}/.env:ro
      # Persist tmux sessions across container restarts
      - r-dev-tmp:/tmp
      # Tentacle data directory
      - /data/echoms/:/data/echoms
    extra_hosts:
      - "dockerhost:host-gateway"
    environment:
      # TERM not set - inherit from SSH client for proper graphics protocol support
      - TZ=America/Los_Angeles
      - GITHUB_PAT=${GITHUB_PAT}
      # Local username for reverse SSH tunnel (nvim quarto-preview â†’ local browser)
      - LOCAL_USER=${LOCAL_USER:-}

  rstudio:
    image: rocker/tidyverse:4.5.2
    container_name: rstudio-rwt
    environment:
      - PASSWORD=${RSTUDIO_PASSWORD:-rstudio}
      # Match host user for file permissions on mounted volumes
      - USERID=${UID:-1000}
      - GROUPID=${GID:-1000}
      # GitHub PAT for pak/remotes to install private packages
      - GITHUB_PAT=${GITHUB_PAT}
    ports:
      - "9010:8787" # RStudio Server
    volumes:
      - ~/projects:/home/rstudio/projects:rw
      - /data/home/scott/projects/argoAPI:/home/rstudio/argoAPI:ro
      - ~/.gitconfig:/home/rstudio/.gitconfig:ro
      - ~/.git-credentials:/home/rstudio/.git-credentials
      # AWS credentials
      - ~/.aws:/home/rstudio/.aws:ro
      # Google auth tokens for gargle/googlesheets4/googledrive
      - ~/.secrets:/home/rstudio/.secrets
      # Tentacle data directory
      - /data/echoms:/data/echoms
    restart: unless-stopped

volumes:
  r-dev-tmp:
