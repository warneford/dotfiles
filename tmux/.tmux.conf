# Tmux Configuration
# Reload with: tmux source-file ~/.tmux.conf

# Set prefix to Ctrl+Space (super ergonomic - thumb on both keys!)
unbind C-b
set-option -g prefix C-Space
bind-key C-Space send-prefix

# Enable mouse support
set -g mouse on

# Start windows and panes at 1, not 0
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on  # Renumber windows when one is closed

# Split panes with intuitive keys (and open in current directory)
bind | split-window -h -c "#{pane_current_path}"   # Split right
bind \\ split-window -hb -c "#{pane_current_path}"  # Split left
bind - split-window -v -c "#{pane_current_path}"   # Split below
bind _ split-window -vb -c "#{pane_current_path}"  # Split above
bind c new-window -c "#{pane_current_path}"  # New window in current dir
unbind '"'
unbind %

# Vim-tmux-navigator integration (Ctrl+hjkl works seamlessly!)
# Smart pane switching with awareness of Vim splits (but NOT Claude Code or radian)
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
bind-key -n 'C-h' if-shell "$is_vim" 'send-keys C-h'  'select-pane -L'
bind-key -n 'C-j' if-shell "$is_vim" 'send-keys C-j'  'select-pane -D'
bind-key -n 'C-k' if-shell "$is_vim" 'send-keys C-k'  'select-pane -U'
bind-key -n 'C-l' if-shell "$is_vim" 'send-keys C-l'  'select-pane -R'

bind-key -T copy-mode-vi 'C-h' select-pane -L
bind-key -T copy-mode-vi 'C-j' select-pane -D
bind-key -T copy-mode-vi 'C-k' select-pane -U
bind-key -T copy-mode-vi 'C-l' select-pane -R

# Easy window navigation (Alt+number)
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-n next-window      # Alt+n
bind -n M-p previous-window  # Alt+p

# Resize panes with Prefix + Arrow keys
bind -r Left resize-pane -L 5
bind -r Right resize-pane -R 5
bind -r Up resize-pane -U 5
bind -r Down resize-pane -D 5

# Swap windows easily
bind -r "<" swap-window -t -1 -d  # Move window left
bind -r ">" swap-window -t +1 -d  # Move window right

# Kill pane without confirmation
bind X kill-pane

# Reload config file
bind r source-file ~/.tmux.conf \; display "âœ“ Config reloaded!"

# Allow programs (like nvim) to set window title
set-option -g allow-rename on

# Enable true color (24-bit) support for pretty colors
set -g default-terminal "tmux-256color"
set -as terminal-overrides ',*:RGB'  # True color support
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'  # colored underlines
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'  # undercurl support
set -as terminal-overrides ',*:sitm=\E[3m'  # italic support

# Increase scrollback buffer size
set -g history-limit 50000

# Display messages for longer
set -g display-time 4000

# Refresh status bar more often
set -g status-interval 5

# Focus events for vim
set -g focus-events on

# Allow passthrough for image rendering (needed for image.nvim, tmux 3.3a+)
# Use -q to suppress error on older tmux versions
set -gq allow-passthrough on

# Enable OSC 52 clipboard (for remote clipboard access through SSH)
set -g set-clipboard on

# Enable extended keys (CSI u / fixterms) passthrough for modern terminals
# Use 'always' to send extended keys without waiting for application to request them
set -g extended-keys always
set -as terminal-features ',*:extkeys'

# Bind Ctrl+Shift+V to paste clipboard image path (for Claude Code)
bind -n C-S-v run-shell "~/.local/bin/paste-image | tr -d '\n' | tmux load-buffer -" \; paste-buffer -d
# Pass through TERM and TERM_PROGRAM for proper terminal detection in SSH sessions
set -ga update-environment TERM
set -ga update-environment TERM_PROGRAM

# Aggressive resize for multiple clients
setw -g aggressive-resize on

# Vi mode for copy mode
setw -g mode-keys vi

# Enter copy mode with Escape (works like vim)
bind Escape copy-mode

# Copy mode selection colors (dark background with peach text)
set -g mode-style bg=colour237,fg=#fab387

# Copy mode bindings
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi y send-keys -X copy-selection-and-cancel
bind-key -T copy-mode-vi Escape send-keys -X cancel

# Status bar positioning (top like macOS)
set -g status-position top

# Status bar styling - Catppuccin Mocha with pills and transparent background
set -g status-style bg=default,fg=#cdd6f4
set -g status-left-length 50
set -g status-right-length 100

# Left: session name (blue pill)
# Icons: \U0000E0B6 (left sep), \U0000E0B4 (right sep), \U0000F179 (apple), \U0000F31B (ubuntu)
set -g status-left "#[fg=#89b4fa,bg=default]\U0000E0B6#[fg=#1e1e2e,bg=#89b4fa,bold] #{?#{==:#{host},tentacle},\U0000F31B,\U0000F179} #S #[fg=#89b4fa,bg=default]\U0000E0B4"

# Center: window list with pills
# Icons: \U0000E0B6 (left sep), \U0000E0B4 (right sep)
set -g status-justify centre
set -g window-status-format "#[fg=#45475a,bg=default]\U0000E0B6#[fg=#cdd6f4,bg=#45475a] #I #W #[fg=#45475a,bg=default]\U0000E0B4"
set -g window-status-current-format "#[fg=#fab387,bg=default]\U0000E0B6#[fg=#1e1e2e,bg=#fab387,bold] #I #W #[fg=#fab387,bg=default]\U0000E0B4"

# Right: directory and time (pink + teal pills)
# Icons: \U0000E0B6 (left sep), \U0000E0B4 (right sep), \U000F0DCF (folder)
set -g status-right "#[fg=#f5c2e7,bg=default]\U0000E0B6#[fg=#1e1e2e,bg=#f5c2e7,bold] \U000F0DCF #{b:pane_current_path} #[fg=#f5c2e7,bg=default]\U0000E0B4 #[fg=#94e2d5,bg=default]\U0000E0B6#[fg=#1e1e2e,bg=#94e2d5] %H:%M #[fg=#94e2d5,bg=default]\U0000E0B4"

# Allow automatic window renaming (shows nvim filename)
set-option -g automatic-rename on
set-option -g automatic-rename-format '#{pane_title}'
set-option -g set-titles on

# Pane border colors
set -g pane-border-style fg=colour238
set -g pane-active-border-style fg=colour51

# Message colors
set -g message-style bg=colour235,fg=colour166

# =============================================================================
# Plugins (manually cloned - no TPM required)
# =============================================================================

# tmux-window-name - auto-rename windows based on running process
# Install: git clone https://github.com/ofirgall/tmux-window-name ~/.tmux/plugins/tmux-window-name
# Requires: python3 -m pip install --user libtmux
set -g @tmux_window_name_use_tilde "True"
set -g @tmux_window_name_shells "['bash', 'zsh', 'sh']"
set -g @tmux_window_name_max_name_len "20"
# nvim/vim excluded - they set their own title with icon + filename
set -g @tmux_window_name_dir_programs "['git', 'radian', 'ipython', 'R']"
set -g @tmux_window_name_ignored_programs "['nvim', 'vim', 'vi']"

# Icon configuration - show icon with program name
set -g @tmux_window_name_icon_style "'icon'"

# Custom icons (Nerd Font) - maps program names to icons
# Icons: git=F02A2, python=E73C, R=F07D4, radian=F0937, zsh=EBC7, node=E718, docker=F308, claude=F4F5
set -g @tmux_window_name_custom_icons '{"git": "\U000F02A2", "python": "\U0000E73C", "python3": "\U0000E73C", "ipython": "\U0000E73C", "radian": "\U000F0937", "R": "\U000F07D4", "node": "\U0000E718", "docker": "\U0000F308", "zsh": "\U0000EBC7", "bash": "\U0000EBC7", "ssh": "\U0000F489", "man": "\U0000F02D", "less": "\U0000F02D", "lazygit": "\U000F02A2", "htop": "\U0000F85A", "btop": "\U0000F85A", "claude": "\U0000F4F5"}'

# Use dedicated Python venv for tmux plugins
set-environment -g TMUX_PLUGIN_MANAGER_PATH "$HOME/.tmux/plugins"
run-shell "~/.local/share/tmux/python-env/bin/python ~/.tmux/plugins/tmux-window-name/scripts/rename_session_windows.py"
